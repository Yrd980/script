bluemonday !GoDochttps://godoc.org/github.com/microcosm-cc/bluemonday !Sourcegraphhttps://sourcegraph.com/github.com/microcosm-cc/bluemonday?badge bluemonday is a HTML sanitizer implemented in Go. It is fast and highly configurable. bluemonday takes untrusted user generated content as an input, and will return HTML that has been sanitised against an allowlist of approved HTML elements and attributes so that you can safely include the content in your web page. If you accept user generated content, and your server uses Go, you need bluemonday. The default policy for user generated content turns this: Into a harmless: And it turns this: Into this: Whilst still allowing this: To pass through mostly unaltered it gained a rel="nofollow" which is a good thing for user generated content: It protects sites from XSS attacks. There are many vectors for an XSS attack and the best way to mitigate the risk is to sanitize user input against a known safe list of HTML elements and attributes. You should always run bluemonday after any other processing. If you use blackfriday or Pandoc then bluemonday should be run after these steps. This ensures that no insecure HTML is introduced later in your process. bluemonday is heavily inspired by both the OWASP Java HTML Sanitizer and the HTML Purifier. Technical Summary Allowlist based, you need to either build a policy describing the HTML elements and attributes to permit and the patterns of attributes, or use one of the supplied policies representing good defaults. The policy containing the allowlist is applied using a fast non-validating, forward only, token-based parser implemented in the Go net/html library by the core Go team. We expect to be supplied with well-formatted HTML closing elements for every applicable open element, nested correctly and so we do not focus on repairing badly nested or incomplete HTML. We focus on simply ensuring that whatever elements do exist are described in the policy allowlist and that attributes and links are safe for use on your web page. GIGO does apply and if you feed it bad HTML bluemonday is not tasked with figuring out how to make it good again. Is it production ready? Yes We are using bluemonday in production having migrated from the widely used and heavily field tested OWASP Java HTML Sanitizer. We are passing our extensive test suite including AntiSamy tests as well as tests for any issues raised. Check for any unresolved issues to see whether anything may be a blocker for you. We invite pull requests and issues to help us ensure we are offering comprehensive protection against various attacks via user generated content. Usage Install using Then call it: We offer three ways to call Sanitize: If you are obsessed about performance, will return a without performing any unnecessary casting of the inputs or outputs. Though the difference is so negligible you should never need to care. You can build your own policies: We ship two default policies: 1. which can be thought of as equivalent to stripping all HTML elements and their attributes as it has nothing on its allowlist. An example usage scenario would be blog post titles where HTML tags are not expected at all and if they are then the elements and the content of the elements should be stripped. This is a very strict policy. 2. which allows a broad selection of HTML elements and attributes that are safe for user generated content. Note that this policy does not allow iframes, object, embed, styles, script, etc. An example usage scenario would be blog post bodies where a variety of formatting is expected along with the potential for TABLEs and IMGs. Policy Building The essence of building a policy is to determine which HTML elements and attributes are considered safe for your scenario. OWASP provide an XSS prevention cheat sheetPreventionCheatSheet to help explain the risks, but essentially: 1. Avoid anything other than the standard HTML elements 1. Avoid , , , , , elements that allow code to be executed by the client or third party content to be included that can execute code 1. Avoid anything other than plain HTML attributes with values matched to a regexp Basically, you should be able to describe what HTML is fine for your scenario. If you do not have confidence that you can describe your policy please consider using one of the shipped policies such as . To create a new policy: To add elements to a policy either add just the elements: Or using a regex: Note: if an element is added by name as shown above, any matching regex will be ignored It is also recommended to ensure multiple patterns don't overlap as order of execution is not guaranteed and can result in some rules being missed. Or add elements as a virtue of adding an attribute: Again, this also supports a regex pattern match alternative: Attributes can either be added to all elements: Or attributes can be added to specific elements: It is always recommended that an attribute be made to match a pattern. XSS in HTML attributes is very easy otherwise: You can stop at any time and call .Sanitize: And you can take any existing policy and extend it: Inline CSS Although it's possible to handle inline CSS using with a rule, writing a single monolithic regular expression to safely process all inline CSS which you wish to allow is not a trivial task. Instead of attempting to do so, you can allow the attribute on whichever elements you desire and use style policies to control and sanitize inline styles. It is strongly recommended that you use with a suitable regular expression , or to ensure each style matches your needs, but default handlers are supplied for most widely used styles. Similar to attributes, you can allow specific CSS properties to be set inline: Additionally, you can allow a CSS property to be set only to an allowed value: Or you can specify elements based on a regex pattern match: If you need more specific checking, you can create a handler that takes in a string and returns a bool to validate the values for a given property. The string parameter has been converted to lowercase and unicode code points have been converted. Links Links are difficult beasts to sanitise safely and also one of the biggest attack vectors for malicious content. It is possible to do this: But that will not protect you as the regular expression is insufficient in this case to have prevented a malformed value doing something unexpected. We provide some additional global options for safely working with links. will ensure that URLs are parseable by Go's package: If you have enabled parseable URLs then the following option will . By default this is disabled bluemonday is an allowlist tool... you need to explicitly tell us to permit things and when disabled it will prevent all local and scheme relative URLs i.e. , and even are relative: If you have enabled parseable URLs then you can allow the schemes commonly called protocol when thinking of and that are permitted. Bear in mind that allowing relative URLs in the above option will allow for a blank scheme: Regardless of whether you have enabled parseable URLs, you can force all URLs to have a rel="nofollow" attribute. This will be added if it does not exist, but only when the is valid: Similarly, you can force all URLs to have "noreferrer" in their rel attribute. We provide a convenience method that applies all of the above, but you will still need to allow the linkable elements for the URL rules to be applied to: An additional complexity regarding links is the data URI as defined in RFC2397. The data URI allows for images to be served inline using this format: We have provided a helper to verify the mimetype followed by base64 content of data URIs links: That helper will enable GIF, JPEG, PNG and WEBP images. It should be noted that there is a potential security risk with the use of data URI links. You should only enable data URI links if you already trust the content. We also have some features to help deal with user generated content: This will ensure that anchor links that are fully qualified the href destination includes a host name will get added to them. Additionally any link that has after the policy has been applied will also have the attribute adjusted to add . This means a link may start like and will end up as . It is important to note that the addition of is a security feature and not an issue. There is an unfortunate feature to browsers that a browser window opened as a result of can still control the opener your web page and this protects against that. The background to this can be found here: https://dev.to/ben/the-targetblank-vulnerability-by-example Policy Building Helpers We also bundle some helpers to simplify policy building: Invalid Instructions The following are invalid: Both examples exhibit the same issue, they declare attributes but do not then specify whether they are allowed globally or only on specific elements and which elements. Attributes belong to one or more elements, and the policy needs to declare this. Limitations We are not yet including any tools to help allow and sanitize CSS. Which means that unless you wish to do the heavy lifting in a single regular expression inadvisable, you should not allow the "style" attribute anywhere. In the same theme, both and are considered harmful. These elements and their content will not be rendered by default, and require you to explicitly set . You should be aware that allowing these elements defeats the purpose of using a HTML sanitizer as you would be explicitly allowing either JavaScript and any plainly written XSS and CSS which can modify a DOM to insert JS, and additionally but limitations in this library mean it is not aware of whether HTML is validly structured and that can allow these elements to bypass some of the safety mechanisms built into the WhatWG HTML parser standard. It is not the job of bluemonday to fix your bad HTML, it is merely the job of bluemonday to prevent malicious HTML getting through. If you have mismatched HTML elements, or non-conforming nesting of elements, those will remain. But if you have well-structured HTML bluemonday will not break it. TODO Investigate whether devs want to blacklist elements and attributes. This would allow devs to take an existing policy such as the that encapsulates 90% of what they're looking for but does more than they need, and to remove the extra things they do not want to make it 100% what they want Investigate whether devs want a validating HTML mode, in which the HTML elements are not just transformed into a balanced tree every start tag has a closing tag at the correct depth but also that elements and character data appear only in their allowed context i.e. that a element isn't a descendent of a , that , , , and are permitted, and that character data is not permitted Long term goals 1. Open the code to adversarial peer review similar to the Attack Review Ground Rules 1. Raise funds and pay for an external security review